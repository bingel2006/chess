<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒäººå¯¹æˆ˜è±¡æ£‹æ¸¸æˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Arial', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            overflow: hidden;
        }
        #container { 
            display: flex; 
            height: 100vh;
            flex-direction: column;
            padding: 10px;
        }
        #top-bar {
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-info {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            min-width: 280px;
            font-size: 13px;
            line-height: 1.6;
        }
        .player1-color { background: #2196F3; }
        .player2-color { background: #F44336; }
        .current-turn {
            box-shadow: 0 0 20px rgba(255,255,255,0.8);
            transform: scale(1.05);
        }
        #board-info {
            background: rgba(0,0,0,0.8);
            padding: 12px 25px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            font-size: 16px;
            font-weight: bold;
        }
        .board-stat {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .stat-label {
            color: #aaa;
        }
        .stat-value {
            font-size: 20px;
            color: #4CAF50;
        }
        .player1-stat { color: #2196F3; }
        .player2-stat { color: #F44336; }
        #main-content {
            display: flex;
            flex: 1;
            gap: 10px;
            overflow: hidden;
        }
        #sidebar {
            width: 300px;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            overflow-y: auto;
        }
        #game-area {
            flex: 1;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 20px;
            overflow: auto;
        }
        .king-image {
            height: 500px;
            width: auto;
            opacity: 0.8;
            pointer-events: none;
        }
        #board {
            display: grid;
            grid-template-columns: repeat(17, 50px);
            grid-template-rows: repeat(11, 50px);
            gap: 2px;
            background: #333;
            padding: 2px;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .cell {
            width: 50px;
            height: 50px;
            background: #2d5016;
            border: 1px solid #1a3009;
            cursor: pointer;
            position: relative;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cell:hover {
            filter: brightness(1.2);
        }
        .cell.river {
            background: #1e88e5;
        }
        .cell.selected {
            box-shadow: 0 0 15px #ffeb3b inset;
            border: 3px solid #ffeb3b;
        }
        .cell.group-selected {
            box-shadow: 0 0 15px #ff9800 inset;
            border: 3px solid #ff9800;
        }
        .cell.movable {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4caf50;
        }
        .cell.attackable {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
        }
        .piece {
            width: 44px;
            height: 44px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            border: 3px solid #000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            cursor: pointer;
            pointer-events: auto;
            color: #000;
        }
        .piece.player1 {
            border-radius: 50%;
        }
        .piece.player2 {
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }
        .piece-name {
            font-size: 11px;
            margin-bottom: 2px;
        }
        .piece-stats {
            font-size: 8px;
            line-height: 1.2;
        }
        .piece.king {
            border: 4px solid gold;
            box-shadow: 0 0 15px gold;
        }
        .obstacle {
            position: absolute;
            top: 3px;
            right: 3px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            font-size: 9px;
            font-weight: bold;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .obstacle.heal { 
            background: #4CAF50; 
            color: white; 
        }
        .obstacle.damage { 
            background: #F44336; 
            color: white; 
        }
        .obstacle.hidden { 
            background: #808080; 
            color: transparent; 
        }
        .section {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        .section h3 {
            margin-bottom: 8px;
            color: #4CAF50;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover { 
            background: #45a049;
            transform: translateY(-2px);
        }
        button:disabled { 
            background: #666; 
            cursor: not-allowed;
            transform: none;
        }
        .role-btn {
            background: #2196F3;
            margin: 3px 0;
            padding: 8px;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .role-btn:hover {
            background: #1976D2;
        }
        .role-price {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
        }
        .action-btn {
            background: #FF9800;
            margin: 3px 0;
        }
        .action-btn:hover {
            background: #F57C00;
        }
        #piece-info {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            max-height: 150px;
            overflow-y: auto;
            border-top: 3px solid #4CAF50;
            transform: translateY(100%);
            transition: transform 0.3s;
        }
        #piece-info.show {
            transform: translateY(0);
        }
        .info-text {
            font-size: 12px;
            line-height: 1.8;
        }
        .phase-setup { display: block; }
        .phase-game { display: none; }
        .game-active .phase-setup { display: none; }
        .game-active .phase-game { display: block; }
        .role-info {
            font-size: 10px;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255,255,255,0.15);
            border-radius: 4px;
            border-left: 3px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .winner-banner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 40px 60px;
            border-radius: 20px;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 0 50px rgba(255,255,255,0.5);
            z-index: 1000;
            display: none;
        }
        .winner-banner.show {
            display: block;
            animation: bounce 0.5s;
        }
        @keyframes bounce {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }
        .selected-role {
            padding: 6px;
            margin: 3px 0;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
        }
        #group-section {
            display: none;
        }
        #group-section.show {
            display: block;
        }
        .wealth-display {
            font-size: 14px;
            color: #FFD700;
            margin: 8px 0;
            padding: 5px;
            background: rgba(255,215,0,0.1);
            border-radius: 4px;
            text-align: center;
        }
        .hp-selector {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        .hp-option {
            flex: 1;
            min-width: 45px;
            padding: 4px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 9px;
            text-align: center;
            transition: all 0.2s;
        }
        .hp-option:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }
        .hp-option.selected {
            background: #4CAF50;
            border-color: #4CAF50;
        }
        .event-section {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #FF9800;
        }
        .event-description {
            font-size: 11px;
            margin: 5px 0;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        #event-target-hint {
            font-size: 10px;
            color: #FF9800;
            margin: 5px 0;
        }
        #instructions-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }
        #instructions-content {
            background: #333;
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            color: #fff;
            font-size: 12px;
            line-height: 1.6;
        }
        #close-instructions {
            background: #F44336;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            float: right;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="top-bar">
            <div class="player-info player1-color" id="player1-info">
                ç©å®¶1 | è´¢å¯Œ: <span id="p1-wealth">1000</span>ğŸ’°<br>
                <span class="turn-status">å‡†å¤‡ä¸­</span>
            </div>
            <button onclick="game.resetGame()" style="width: 150px;">é‡æ–°å¼€å§‹</button>
            <div class="player-info player2-color" id="player2-info">
                ç©å®¶2 | è´¢å¯Œ: <span id="p2-wealth">1000</span>ğŸ’°<br>
                <span class="turn-status">å‡†å¤‡ä¸­</span>
            </div>
        </div>

        <div id="board-info">
            <div class="board-stat">
                <span class="stat-label">ç©å®¶1æ£‹å­:</span>
                <span class="stat-value player1-stat" id="p1-pieces-top">0</span>
            </div>
            <div class="board-stat">
                <span class="stat-label">ç©å®¶2æ£‹å­:</span>
                <span class="stat-value player2-stat" id="p2-pieces-top">0</span>
            </div>
        </div>

        <div id="main-content">
            <div id="sidebar">
                <div class="phase-setup">
                    <div class="section">
                        <h3>ğŸ® æ¸¸æˆå‡†å¤‡</h3>
                        <div style="font-size: 12px; margin: 10px 0;">
                            å½“å‰: <span id="setup-player">ç©å®¶1</span> é€‰æ‹©è§’è‰²
                        </div>
                        <div class="wealth-display">
                            å‰©ä½™è´¢å¯Œ: <span id="current-wealth">1000</span>ğŸ’°
                        </div>
                        <button onclick="game.switchSetupPlayer()">åˆ‡æ¢ç©å®¶</button>
                        <button id="obs-btn" onclick="game.regenerateObstacles()">éšæœºç”Ÿæˆéšœç¢ç‰©</button>
                    </div>

                    <div class="section">
                        <h3>ğŸ‘¥ é€‰æ‹©è§’è‰² (æœ€å¤š9ä¸ª)</h3>
                        
                        <div class="role-info" style="border-color: #4CAF50;">
                            <div>
                                <b>å£«å…µ</b> åŸºç¡€HP:80 ATK:15 é€Ÿåº¦:2
                            </div>
                            <div class="role-price">50ğŸ’°</div>
                        </div>
                        <div class="hp-selector">
                            <div class="hp-option" onclick="game.selectRole('soldier', 80, 50)">80HP<br>50ğŸ’°</div>
                            <div class="hp-option" onclick="game.selectRole('soldier', 100, 70)">100HP<br>70ğŸ’°</div>
                            <div class="hp-option" onclick="game.selectRole('soldier', 120, 90)">120HP<br>90ğŸ’°</div>
                        </div>
                        
                        <div class="role-info" style="border-color: #2196F3; margin-top: 10px;">
                            <div>
                                <b>è°‹å£«</b> åŸºç¡€HP:60 ATK:25 é€Ÿåº¦:3
                            </div>
                            <div class="role-price">80ğŸ’°</div>
                        </div>
                        <div class="hp-selector">
                            <div class="hp-option" onclick="game.selectRole('strategist', 60, 80)">60HP<br>80ğŸ’°</div>
                            <div class="hp-option" onclick="game.selectRole('strategist', 80, 110)">80HP<br>110ğŸ’°</div>
                            <div class="hp-option" onclick="game.selectRole('strategist', 100, 140)">100HP<br>140ğŸ’°</div>
                        </div>
                        
                        <div class="role-info" style="border-color: #F44336; margin-top: 10px;">
                            <div>
                                <b>å°†å†›</b> åŸºç¡€HP:100 ATK:20 é€Ÿåº¦:2
                            </div>
                            <div class="role-price">100ğŸ’°</div>
                        </div>
                        <div class="hp-selector">
                            <div class="hp-option" onclick="game.selectRole('general', 100, 100)">100HP<br>100ğŸ’°</div>
                            <div class="hp-option" onclick="game.selectRole('general', 130, 140)">130HP<br>140ğŸ’°</div>
                            <div class="hp-option" onclick="game.selectRole('general', 160, 180)">160HP<br>180ğŸ’°</div>
                        </div>
                        
                        <div class="role-info" style="border-color: #9C27B0; margin-top: 10px;">
                            <div>
                                <b>å·¥äºº</b> åŸºç¡€HP:70 ATK:10 é€Ÿåº¦:4
                            </div>
                            <div class="role-price">60ğŸ’°</div>
                        </div>
                        <div class="hp-selector">
                            <div class="hp-option" onclick="game.selectRole('worker', 70, 60)">70HP<br>60ğŸ’°</div>
                            <div class="hp-option" onclick="game.selectRole('worker', 90, 85)">90HP<br>85ğŸ’°</div>
                            <div class="hp-option" onclick="game.selectRole('worker', 110, 110)">110HP<br>110ğŸ’°</div>
                        </div>
                        
                        <div class="role-info" style="border-color: #FF9800; margin-top: 10px;">
                            <div>
                                <b>åˆºå®¢</b> åŸºç¡€HP:50 ATK:30 é€Ÿåº¦:3
                            </div>
                            <div class="role-price">90ğŸ’°</div>
                        </div>
                        <div class="hp-selector">
                            <div class="hp-option" onclick="game.selectRole('assassin', 50, 90)">50HP<br>90ğŸ’°</div>
                            <div class="hp-option" onclick="game.selectRole('assassin', 70, 125)">70HP<br>125ğŸ’°</div>
                            <div class="hp-option" onclick="game.selectRole('assassin', 90, 160)">90HP<br>160ğŸ’°</div>
                        </div>

                        <div style="margin-top: 10px; font-size: 11px;">
                            å·²é€‰: <span id="selected-count">0</span>/9
                        </div>
                    </div>

                    <div class="section">
                        <h3>å·²é€‰æ‹©è§’è‰²</h3>
                        <div id="selected-roles"></div>
                    </div>

                    <div class="section">
                        <h3>â–¶ï¸ å¼€å§‹æ¸¸æˆ</h3>
                        <button onclick="game.finishCurrentSetup()" id="finish-setup-btn">å®Œæˆé€‰æ‹©</button>
                        <button onclick="game.startGame()" id="start-game-btn" disabled>å¼€å§‹å¯¹æˆ˜</button>
                    </div>

                    <div class="section">
                        <h3>â„¹ï¸ æ¸¸æˆè¯´æ˜</h3>
                        <div style="font-size: 10px; line-height: 1.6;">
                            <div>â€¢ åŒæ–¹å„æœ‰1000ğŸ’°è´¢å¯Œ</div>
                            <div>â€¢ è´­ä¹°è§’è‰²æ—¶å¯é€‰æ‹©ä¸åŒHPç­‰çº§</div>
                            <div>â€¢ HPè¶Šé«˜ä»·æ ¼è¶Šè´µ</div>
                            <div>â€¢ æœ€å¤š9ä¸ªæ£‹å­+1ä¸ªå›½ç‹</div>
                            <div>â€¢ è½®æµç§»åŠ¨ï¼Œå‡»è´¥å¯¹æ–¹å›½ç‹è·èƒœ</div>
                            <div>â€¢ æ”¯æŒæ‹†åˆ†æ£‹å­å’Œç»„é˜Ÿæ”»å‡»</div>
                        </div>
                    </div>
                </div>

                <div class="phase-game">
                    <div class="section">
                        <h3>ğŸ“Š æ¸¸æˆçŠ¶æ€</h3>
                        <div style="font-size: 11px; line-height: 1.8;">
                            <div>å½“å‰å›åˆ: <span id="current-player-text">ç©å®¶1</span></div>
                            <div>ç©å®¶1æ£‹å­: <span id="p1-pieces-game">0</span></div>
                            <div>ç©å®¶2æ£‹å­: <span id="p2-pieces-game">0</span></div>
                        </div>
                    </div>

                    <div class="section">
                        <h3>ğŸ“– å®Œæ•´æ¸¸æˆè¯´æ˜</h3>
                        <button onclick="game.showInstructions()">æŸ¥çœ‹ä½¿ç”¨è¯´æ˜</button>
                    </div>

                    <div class="section event-section">
                        <h3>ğŸ² éšæœºäº‹ä»¶</h3>
                        <div>å‰©ä½™æŠ½å–: <span id="event-draws">3</span>æ¬¡</div>
                        <button id="draw-event-btn" onclick="game.drawRandomEvent()" class="action-btn">æŠ½å–éšæœºäº‹ä»¶</button>
                        <div id="event-description" class="event-description" style="display: none;"></div>
                        <div id="event-target-hint" style="display: none;">ç‚¹å‡»æ£‹ç›˜ä¸Šä»»æ„æ£‹å­åº”ç”¨äº‹ä»¶</div>
                    </div>

                    <div class="section">
                        <h3>ğŸ¯ æ“ä½œæç¤º</h3>
                        <div style="font-size: 11px; line-height: 1.6; margin-bottom: 10px;">
                            <div id="game-hint">ç‚¹å‡»ä½ çš„æ£‹å­é€‰æ‹©ï¼Œç„¶åç‚¹å‡»å¯è¾¾æ ¼å­ç§»åŠ¨</div>
                        </div>
                        <div id="action-buttons" style="display: none;">
                            <button class="action-btn" onclick="game.splitPiece()">æ‹†åˆ†æ£‹å­</button>
                            <button class="action-btn" onclick="game.toggleGroupSelect()">ç»„é˜Ÿæ¨¡å¼</button>
                        </div>
                        <button onclick="game.endTurn()">ç»“æŸå›åˆ</button>
                    </div>

                    <div class="section" id="group-section">
                        <h3>ç»„é˜Ÿæ”»å‡»</h3>
                        <div style="font-size: 11px; margin-bottom: 8px;">ç‚¹å‡»ç›¸é‚»æ£‹å­ç»„é˜Ÿï¼Œç„¶åæ”»å‡»æ•Œæ–¹</div>
                        <div id="group-info">ç»„é˜Ÿ: 0 æ£‹å­</div>
                        <button class="action-btn" onclick="game.executeGroupAttack()">æ‰§è¡Œç»„é˜Ÿæ”»å‡»</button>
                    </div>
                </div>
            </div>

            <div id="game-area">
                <img src="king1.png" alt="War King Left" class="king-image">
                <div id="board"></div>
                <img src="king2.png" alt="War King Right" class="king-image">
            </div>
        </div>
    </div>

    <div id="piece-info">
        <div class="info-text" id="piece-info-text">ç‚¹å‡»æ£‹å­æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</div>
    </div>

    <div id="winner-banner" class="winner-banner"></div>

    <div id="instructions-modal">
        <div id="instructions-content">
            <button id="close-instructions" onclick="game.hideInstructions()">å…³é—­</button>
            <h2>åŒäººå¯¹æˆ˜è±¡æ£‹æ¸¸æˆ - å®Œæ•´ä½¿ç”¨è¯´æ˜</h2>
            <div style="font-size: 14px; line-height: 1.6; white-space: pre-wrap;">
## æ¸¸æˆè§„åˆ™

### 1. å‡†å¤‡é˜¶æ®µ
- åŒæ–¹è½®æµè´­ä¹°æ£‹å­ï¼ˆæœ€å¤š9ä¸ª + 1å›½ç‹è‡ªåŠ¨æ·»åŠ ï¼‰ã€‚
- åˆå§‹è´¢å¯Œï¼š1000ğŸ’°ã€‚
- æ£‹å­ç±»å‹ï¼šå£«å…µã€è°‹å£«ã€å°†å†›ã€å·¥äººã€åˆºå®¢ã€‚
- é€‰æ‹© HP ç­‰çº§ï¼Œä»·æ ¼è¶Šé«˜ HP è¶Šé«˜ï¼ˆå‡çº§é€‰é¡¹è§è´­ä¹°ç•Œé¢ï¼‰ã€‚
- å®Œæˆé€‰æ‹©åï¼Œæ£‹å­éšæœºæ”¾ç½®åœ¨åæ’ï¼ˆé¿å…éšœç¢ï¼‰ã€‚
- å›½ç‹åˆå§‹ HP=150, ATK=30, é€Ÿåº¦=2ï¼ˆé‡‘è‰²æ ‡è¯†ï¼‰ã€‚

### 2. æ¸¸æˆé˜¶æ®µ
- **å›åˆåˆ¶**ï¼šç©å®¶1 å…ˆæ‰‹ï¼Œè½®æµè¡ŒåŠ¨ã€‚ç»“æŸå›åˆåˆ‡æ¢ç©å®¶ã€‚
- **è¡ŒåŠ¨é¡ºåº**ï¼ˆæœ¬å›åˆé™1æ¬¡ä¸»è¦è¡ŒåŠ¨ï¼‰ï¼š
  - **ç§»åŠ¨/æ”»å‡»**ï¼šç‚¹å‡»ä½ çš„æ£‹å­é€‰æ‹©ï¼ˆé»„è‰²é«˜äº®ï¼‰ï¼Œç„¶åç‚¹å‡»æ›¼å“ˆé¡¿è·ç¦» <= é€Ÿåº¦ çš„æ ¼å­ã€‚
    - ç©ºä½ï¼šç§»åŠ¨åˆ°è¯¥æ ¼ï¼ˆå¯èƒ½è§¦å‘éšœç¢ Â±30 HPï¼‰ã€‚
    - æ•Œæ–¹ï¼šæ”»å‡»ï¼äº’æŸï¼ˆåŒæ–¹ HP -= å¯¹æ–¹ ATKï¼‰ã€‚é˜²å¾¡æ–¹æ­»äº¡åï¼Œæ”»å‡»æ–¹ç§»è‡³å…¶ä½ç½®ã€‚
    - æ²³æ ¼ï¼ˆç¬¬9åˆ—ï¼‰ï¼šä¸å¯ç§»åŠ¨/å é¢†ã€‚
  - **æ‹†åˆ†æ£‹å­**ï¼šé€‰æ£‹å­åç‚¹å‡»æŒ‰é’®ï¼Œéšæœºæ‹†åˆ†æˆ2-4ä¸ªå­å•ä½ï¼ˆHP å‡åˆ†ï¼Œéœ€å‘¨è¾¹ç©ºä½ï¼‰ã€‚è§†ä¸ºæœ¬å›åˆè¡ŒåŠ¨ã€‚
  - **ç»„é˜Ÿæ”»å‡»**ï¼šåˆ‡æ¢ç»„é˜Ÿæ¨¡å¼ï¼Œç‚¹å‡»ç›¸é‚»ä½ çš„æ£‹å­é€‰ç»„ï¼ˆæ©™è‰²é«˜äº®ï¼Œâ‰¥2ä¸ªï¼‰ï¼Œç‚¹å‡»ç›¸é‚»æ•Œæ–¹æ‰§è¡Œã€‚æ€» ATK vs ç›®æ ‡ HPï¼šæˆåŠŸå‡»è´¥ç›®æ ‡ï¼ˆæ”»å‡»æ–¹ -10 HPï¼‰ï¼Œå¤±è´¥å…¨æ­»ã€‚
- **éšæœºäº‹ä»¶**ï¼šæ¯ç©å®¶3æ¬¡æŠ½å–ï¼ˆå›åˆå†…ç”¨ï¼Œè§†ä¸ºè¡ŒåŠ¨ï¼‰ã€‚æŠ½å–åè‹¥éœ€ç›®æ ‡ï¼Œç‚¹å‡»ä»»æ„æ£‹å­åº”ç”¨ã€‚
  - é™¨çŸ³æ”»å‡»ï¼š-50 HP ç»™é€‰æ£‹å­ã€‚
  - å‘ç°çŸ³æ²¹ï¼š+200ğŸ’° è´¢å¯Œã€‚
  - ç¥ç§˜æ²»ç–—ï¼šé€‰æ£‹å­æ»¡ HPã€‚
  - åœ°éœ‡ï¼šæ‰€æœ‰æ£‹å­ -10 HPã€‚
  - å¹¸è¿buffï¼šé€‰æ£‹å­ +20 ATKï¼ˆæœ¬å›åˆï¼‰ã€‚

### 3. æ£‹å­å±æ€§
| æ£‹å­ | åŸºç¡€ HP | ATK | é€Ÿåº¦ | é¢œè‰² | åŸºç¡€ä»·æ ¼ | è¯´æ˜ |
|------|---------|-----|------|------|----------|------|
| å£«å…µ | 80 | 15 | 2 | ç»¿è‰² | 50ğŸ’° | å¹³è¡¡è‚‰ç›¾ã€‚ |
| è°‹å£« | 60 | 25 | 3 | è“è‰² | 80ğŸ’° | é«˜è¾“å‡ºï¼ŒæœºåŠ¨ã€‚ |
| å°†å†› | 100 | 20 | 2 | çº¢è‰² | 100ğŸ’° | é«˜è€ä¹…å¦å…‹ã€‚ |
| å·¥äºº | 70 | 10 | 4 | ç´«è‰² | 60ğŸ’° | é«˜é€Ÿä¾¦å¯Ÿã€‚ |
| åˆºå®¢ | 50 | 30 | 3 | æ©™è‰² | 90ğŸ’° | è„†çš®ç§’æ€ã€‚ |
| å›½ç‹ | 150 | 30 | 2 | é‡‘è‰² | æ—  | æ ¸å¿ƒï¼Œåå‡»å¼ºã€‚ |

- HP å‡çº§å¢åŠ ä»·æ ¼ï¼ˆe.g., å£«å…µ 100HP=70ğŸ’°ï¼‰ã€‚
- currentHPï¼šå½“å‰ç”Ÿå‘½ï¼Œâ‰¤0 æ­»äº¡ç§»é™¤ã€‚
- tempATKï¼šä¸´æ—¶ buffï¼ˆå›åˆç»“æŸæ¸…ï¼‰ã€‚

### 4. èƒœåˆ©ä¸æ³¨æ„
- **èƒœåˆ©**ï¼šå‡»è´¥æ•Œå›½ç‹ï¼ˆæ’­æ”¾éŸ³æ•ˆï¼Œå¼¹çª—å®£å¸ƒï¼‰ã€‚
- **éšœç¢**ï¼šé™†åœ°éšæœº +30(ç»¿)/-30(çº¢) HPï¼Œé¦–æ¬¡è¸©è§¦å‘ã€‚
- **UI**ï¼šæ£‹å­æ˜¾ç¤º HP/æ€»HPï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ï¼ˆåº•éƒ¨é¢æ¿ï¼‰ã€‚
- **æç¤º**ï¼šè¡ŒåŠ¨åé«˜äº®æ¶ˆå¤±ã€‚æ— è¡ŒåŠ¨å¯ç»“æŸå›åˆã€‚
- **é‡ç½®**ï¼šç‚¹å‡»â€œé‡æ–°å¼€å§‹â€ä»å¤´ã€‚
- **æŠ€å·§**ï¼šä¿æŠ¤å›½ç‹ï¼Œç”¨é«˜ ATK å›´æ”»æ•Œç‹ï¼›äº‹ä»¶/ç»„é˜Ÿæ”¾å¤§ä¼˜åŠ¿ã€‚

äº«å—æ¸¸æˆï¼å¦‚æœ‰é—®é¢˜ï¼Œé‡å¯æˆ–æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ã€‚
            </div>
        </div>
    </div>

    <script>
        class Game {
            constructor() {
                this.boardWidth = 17;
                this.boardHeight = 11;
                this.riverX = 8;
                this.board = [];
                this.currentPhase = 'setup';
                this.setupPlayer = 1;
                this.playerRoles = [[], []];
                this.playerWealth = [1000, 1000];
                this.currentPlayer = 1;
                this.selectedPiece = null;
                this.selectedGroup = [];
                this.groupSelectMode = false;
                this.gameStarted = false;
                this.gameEnded = false;
                this.hasMoved = false;
                this.audioContext = null;
                this.eventDraws = [3, 3]; // ç©å®¶1å’Œ2å„3æ¬¡æŠ½å–
                
                this.roleTypes = {
                    soldier: { name: 'å£«å…µ', baseHP: 80, atk: 15, speed: 2, color: '#4CAF50', basePrice: 50 },
                    strategist: { name: 'è°‹å£«', baseHP: 60, atk: 25, speed: 3, color: '#2196F3', basePrice: 80 },
                    general: { name: 'å°†å†›', baseHP: 100, atk: 20, speed: 2, color: '#F44336', basePrice: 100 },
                    worker: { name: 'å·¥äºº', baseHP: 70, atk: 10, speed: 4, color: '#9C27B0', basePrice: 60 },
                    assassin: { name: 'åˆºå®¢', baseHP: 50, atk: 30, speed: 3, color: '#FF9800', basePrice: 90 },
                    king: { name: 'å›½ç‹', hp: 150, atk: 30, speed: 2, color: '#FFD700' }
                };

                this.randomEvents = [
                    {
                        name: 'é™¨çŸ³æ”»å‡»',
                        description: 'éšæœºé€ æˆ50ä¼¤å®³ç»™é€‰ä¸­çš„æ£‹å­',
                        requiresTarget: true,
                        effect: (game, target) => {
                            target.currentHP = Math.max(0, target.currentHP - 50);
                            if (target.currentHP <= 0) {
                                target.alive = false;
                            }
                            alert(`é™¨çŸ³æ”»å‡»ï¼${target.name} å—åˆ°50ä¼¤å®³ã€‚`);
                        }
                    },
                    {
                        name: 'å‘ç°çŸ³æ²¹',
                        description: 'è·å¾—200è´¢å¯Œ',
                        requiresTarget: false,
                        effect: (game) => {
                            game.playerWealth[game.currentPlayer - 1] += 200;
                            alert('å‘ç°çŸ³æ²¹ï¼è·å¾—200ğŸ’°è´¢å¯Œã€‚');
                            game.updateWealthDisplay();
                        }
                    },
                    {
                        name: 'ç¥ç§˜æ²»ç–—',
                        description: 'æ¢å¤é€‰ä¸­çš„æ£‹å­æ»¡HP',
                        requiresTarget: true,
                        effect: (game, target) => {
                            target.currentHP = target.hp;
                            alert(`ç¥ç§˜æ²»ç–—ï¼${target.name} HPæ¢å¤æ»¡å€¼ã€‚`);
                        }
                    },
                    {
                        name: 'åœ°éœ‡',
                        description: 'æ‰€æœ‰æ£‹å­å¤±å»10HP',
                        requiresTarget: false,
                        effect: (game) => {
                            game.playerRoles.flat().forEach(role => {
                                if (role.alive) {
                                    role.currentHP = Math.max(1, role.currentHP - 10);
                                }
                            });
                            alert('åœ°éœ‡ï¼æ‰€æœ‰æ£‹å­å¤±å»10HPã€‚');
                        }
                    },
                    {
                        name: 'å¹¸è¿buff',
                        description: '+20 ATKç»™é€‰ä¸­çš„æ£‹å­ (æœ¬å›åˆ)',
                        requiresTarget: true,
                        effect: (game, target) => {
                            target.tempATK = (target.tempATK || target.atk) + 20;
                            alert(`å¹¸è¿buffï¼${target.name} ATKä¸´æ—¶+20ã€‚`);
                        }
                    }
                ];
                
                this.currentEvent = null;
                this.eventTargetMode = false;
                
                this.initBoard();
                this.generateObstacles();
                this.updateUI();
            }

            showInstructions() {
                document.getElementById('instructions-modal').style.display = 'flex';
            }

            hideInstructions() {
                document.getElementById('instructions-modal').style.display = 'none';
            }

            playVictorySound() {
                if (this.audioContext === null) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
                oscillator.frequency.linearRampToValueAtTime(600, this.audioContext.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.5);
            }

            getAliveCount(player) {
                return this.playerRoles[player - 1].filter(role => role.alive).length;
            }

            initBoard() {
                const boardEl = document.getElementById('board');
                boardEl.innerHTML = '';
                this.board = [];
                
                for (let y = 0; y < this.boardHeight; y++) {
                    for (let x = 0; x < this.boardWidth; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        if (x === this.riverX) cell.classList.add('river');
                        cell.dataset.x = x;
                        cell.dataset.y = y;
                        cell.onclick = (e) => {
                            if (e.target === cell) {
                                this.onCellClick(parseInt(cell.dataset.x), parseInt(cell.dataset.y));
                            }
                        };
                        boardEl.appendChild(cell);
                        
                        this.board.push({
                            x, y,
                            element: cell,
                            piece: null,
                            obstacle: null
                        });
                    }
                }
            }

            getCell(x, y) {
                return this.board.find(c => c.x === x && c.y === y);
            }

            generateObstacles() {
                this.board.forEach(cell => cell.obstacle = null);
                const numObstacles = 25;
                let placed = 0;
                while (placed < numObstacles) {
                    const idx = Math.floor(Math.random() * this.board.length);
                    const cell = this.board[idx];
                    if (cell.x !== this.riverX && !cell.obstacle) {
                        const isGood = Math.random() > 0.5;
                        cell.obstacle = {
                            type: isGood ? 'heal' : 'damage',
                            amount: 30,
                            revealed: false
                        };
                        placed++;
                    }
                }
            }

            regenerateObstacles() {
                if (this.setupPlayer !== 1) return;
                this.generateObstacles();
                this.renderBoard();
            }

            selectRole(type, hp, price) {
                const currentRoles = this.playerRoles[this.setupPlayer - 1];
                if (currentRoles.length >= 9) {
                    alert('æœ€å¤š9ä¸ªæ£‹å­ï¼');
                    return;
                }
                
                if (this.playerWealth[this.setupPlayer - 1] < price) {
                    alert('è´¢å¯Œä¸è¶³ï¼');
                    return;
                }
                
                const baseRole = this.roleTypes[type];
                const role = {
                    ...baseRole,
                    hp: hp,
                    currentHP: hp,
                    price: price,
                    id: Date.now() + Math.random(),
                    player: this.setupPlayer,
                    alive: false
                };
                
                this.playerWealth[this.setupPlayer - 1] -= price;
                currentRoles.push(role);
                this.updateSelectedCount();
                this.updateWealthDisplay();
            }

            updateWealthDisplay() {
                document.getElementById('current-wealth').textContent = this.playerWealth[this.setupPlayer - 1];
                document.getElementById('p1-wealth').textContent = this.playerWealth[0];
                document.getElementById('p2-wealth').textContent = this.playerWealth[1];
            }

            updateSelectedCount() {
                const currentRoles = this.playerRoles[this.setupPlayer - 1];
                const count = currentRoles.length;
                document.getElementById('selected-count').textContent = count;
                const sel = document.getElementById('selected-roles');
                sel.innerHTML = '';
                currentRoles.forEach((role, idx) => {
                    const d = document.createElement('div');
                    d.className = 'selected-role';
                    d.style.color = role.color;
                    d.innerHTML = `
                        <span>${role.name} HP:${role.hp}</span>
                        <span>${role.price}ğŸ’°</span>
                    `;
                    sel.appendChild(d);
                });
                document.getElementById('finish-setup-btn').disabled = count === 0;
            }

            switchSetupPlayer() {
                this.setupPlayer = 3 - this.setupPlayer;
                document.getElementById('setup-player').textContent = `ç©å®¶${this.setupPlayer}`;
                this.updateSelectedCount();
                this.updateWealthDisplay();
            }

            finishCurrentSetup() {
                const currentRoles = this.playerRoles[this.setupPlayer - 1];
                if (currentRoles.length === 0) {
                    alert('è¯·è‡³å°‘é€‰æ‹©1ä¸ªè§’è‰²ï¼');
                    return;
                }
                if (this.setupPlayer === 1) {
                    this.switchSetupPlayer();
                } else {
                    document.getElementById('start-game-btn').disabled = false;
                }
            }

            startGame() {
                const king1 = { ...this.roleTypes.king, id: 'king1', currentHP: 150, player: 1, alive: false };
                this.playerRoles[0].push(king1);
                const king2 = { ...this.roleTypes.king, id: 'king2', currentHP: 150, player: 2, alive: false };
                this.playerRoles[1].push(king2);

                this.placePieces();
                this.currentPhase = 'game';
                this.gameStarted = true;
                this.gameEnded = false;
                this.hasMoved = false;
                this.currentPlayer = 1;
                document.body.classList.add('game-active');
                this.renderBoard();
                this.updateUI();
            }

            placePieces() {
                for (let p = 1; p <= 2; p++) {
                    const playerRoles = this.playerRoles[p - 1];
                    const backX = p === 1 ? 0 : this.boardWidth - 1;
                    const secondX = p === 1 ? 1 : this.boardWidth - 2;
                    const centerY = 5;

                    const king = playerRoles.find(r => r.name === 'å›½ç‹');
                    if (king) {
                        let posX = backX;
                        let cell = this.getCell(posX, centerY);
                        if (!cell || cell.obstacle) {
                            posX = secondX;
                            cell = this.getCell(posX, centerY);
                        }
                        king.posX = posX;
                        king.posY = centerY;
                        king.alive = true;
                    }

                    let otherPositions = [];
                    for (let y = 0; y < this.boardHeight; y++) {
                        if (y !== centerY || backX !== (king ? king.posX : -1)) {
                            const cell = this.getCell(backX, y);
                            if (cell && !cell.obstacle) {
                                otherPositions.push({x: backX, y});
                            }
                        }
                    }
                    const numOthers = playerRoles.length - 1;
                    while (otherPositions.length < numOthers) {
                        for (let y = 0; y < this.boardHeight; y++) {
                            const cell = this.getCell(secondX, y);
                            if (cell && !cell.obstacle && !otherPositions.some(pos => pos.x === secondX && pos.y === y)) {
                                otherPositions.push({x: secondX, y});
                                break;
                            }
                        }
                        break;
                    }

                    for (let i = otherPositions.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [otherPositions[i], otherPositions[j]] = [otherPositions[j], otherPositions[i]];
                    }

                    const otherRoles = playerRoles.filter(r => r !== king);
                    otherRoles.forEach((role, idx) => {
                        if (idx < otherPositions.length) {
                            role.posX = otherPositions[idx].x;
                            role.posY = otherPositions[idx].y;
                            role.alive = true;
                        }
                    });
                }
            }

            renderBoard() {
                this.board.forEach(cellData => {
                    const cell = cellData.element;
                    cell.innerHTML = '';
                    cellData.piece = null;
                    cell.classList.remove('selected', 'group-selected', 'movable', 'attackable');
                    
                    if (cellData.obstacle) {
                        const obsEl = document.createElement('div');
                        const isRevealed = cellData.obstacle.revealed;
                        obsEl.className = `obstacle ${isRevealed ? cellData.obstacle.type : 'hidden'}`;
                        if (isRevealed) {
                            obsEl.textContent = cellData.obstacle.type === 'heal' ? '+' : '-';
                        }
                        cell.appendChild(obsEl);
                    }
                });

                this.playerRoles.flat().forEach(role => {
                    if (!role.alive) return;
                    const cellData = this.getCell(role.posX, role.posY);
                    if (!cellData) return;
                    cellData.piece = role;
                    const cell = cellData.element;
                    const pieceEl = document.createElement('div');
                    pieceEl.className = `piece player${role.player} ${role.name === 'å›½ç‹' ? 'king' : ''}`;
                    pieceEl.style.backgroundColor = role.color;
                    pieceEl.onclick = (e) => {
                        e.stopPropagation();
                        this.onPieceClick(role);
                    };
                    const nameEl = document.createElement('div');
                    nameEl.className = 'piece-name';
                    nameEl.textContent = role.name.charAt(0);
                    const statsEl = document.createElement('div');
                    statsEl.className = 'piece-stats';
                    statsEl.textContent = `${role.currentHP}/${role.hp}`;
                    pieceEl.appendChild(nameEl);
                    pieceEl.appendChild(statsEl);
                    cell.appendChild(pieceEl);
                });

                if (this.selectedPiece) {
                    const cell = this.getCell(this.selectedPiece.posX, this.selectedPiece.posY);
                    if (cell) cell.element.classList.add('selected');
                    this.highlightMovable();
                }

                this.selectedGroup.forEach(role => {
                    const cell = this.getCell(role.posX, role.posY);
                    if (cell) cell.element.classList.add('group-selected');
                });
            }

            onPieceClick(role) {
                if (this.currentPhase !== 'game' || this.gameEnded) return;
                
                if (this.eventTargetMode && this.currentEvent && this.currentEvent.requiresTarget) {
                    this.currentEvent.effect(this, role);
                    this.endEventMode();
                    return;
                }
                
                if (this.groupSelectMode && role.player === this.currentPlayer) {
                    if (this.selectedGroup.includes(role)) {
                        this.selectedGroup = this.selectedGroup.filter(r => r !== role);
                    } else if (this.isAdjacentToGroup(role)) {
                        this.selectedGroup.push(role);
                    }
                    this.updateGroupUI();
                    this.renderBoard();
                } else if (role.player === this.currentPlayer && !this.groupSelectMode) {
                    this.selectPiece(role);
                }
                this.showPieceInfo(role);
            }

            isAdjacentToGroup(role) {
                if (this.selectedGroup.length === 0) return true;
                return this.selectedGroup.some(g => this.getManhattanDistance(g.posX, g.posY, role.posX, role.posY) === 1);
            }

            getManhattanDistance(x1, y1, x2, y2) {
                return Math.abs(x1 - x2) + Math.abs(y1 - y2);
            }

            updateGroupUI() {
                document.getElementById('group-info').textContent = `ç»„é˜Ÿ: ${this.selectedGroup.length} æ£‹å­`;
                document.getElementById('group-section').classList.toggle('show', this.selectedGroup.length > 1);
            }

            toggleGroupSelect() {
                this.groupSelectMode = !this.groupSelectMode;
                this.selectedPiece = null;
                this.selectedGroup = [];
                this.updateGroupUI();
                this.renderBoard();
                document.getElementById('game-hint').textContent = this.groupSelectMode ? 'ç‚¹å‡»ç›¸é‚»æ£‹å­ç»„é˜Ÿ' : 'ç‚¹å‡»ä½ çš„æ£‹å­é€‰æ‹©';
            }

            executeGroupAttack() {
                if (this.selectedGroup.length < 2) {
                    alert('è‡³å°‘éœ€è¦2ä¸ªæ£‹å­ç»„é˜Ÿï¼');
                    return;
                }
                const targets = this.getAdjacentEnemies(this.selectedGroup);
                if (targets.length === 0) {
                    alert('å‘¨å›´æ²¡æœ‰æ•Œæ–¹æ£‹å­ï¼');
                    return;
                }
                
                let totalATK = this.selectedGroup.reduce((sum, r) => sum + (r.tempATK || r.atk), 0);
                const target = targets[0];
                
                if (totalATK >= target.currentHP) {
                    target.alive = false;
                    this.selectedGroup.forEach(r => {
                        r.currentHP = Math.max(1, r.currentHP - 10);
                        if (r.tempATK) delete r.tempATK;
                    });
                    alert(`ç»„é˜Ÿæ”»å‡»æˆåŠŸï¼å‡»è´¥äº†${target.name}`);
                } else {
                    this.selectedGroup.forEach(r => r.alive = false);
                    alert('ç»„é˜Ÿæ”»å‡»å¤±è´¥ï¼Œæ‰€æœ‰æ”»å‡»æ£‹å­é˜µäº¡ï¼');
                }
                
                this.selectedGroup = [];
                this.groupSelectMode = false;
                this.hasMoved = true;
                this.updateGroupUI();
                this.renderBoard();
                this.checkWin();
            }

            getAdjacentEnemies(pieces) {
                const enemies = [];
                pieces.forEach(piece => {
                    const adjacent = this.getAdjacentCells(piece.posX, piece.posY, 1);
                    adjacent.forEach(cell => {
                        if (cell.piece && cell.piece.player !== this.currentPlayer && 
                            cell.piece.alive && !enemies.includes(cell.piece)) {
                            enemies.push(cell.piece);
                        }
                    });
                });
                return enemies;
            }

            splitPiece() {
                if (!this.selectedPiece || this.hasMoved) {
                    alert('æœ¬å›åˆå·²ç»ç§»åŠ¨è¿‡äº†ï¼');
                    return;
                }
                
                const numSplit = Math.floor(Math.random() * 3) + 2;
                const newHP = Math.floor(this.selectedPiece.currentHP / numSplit);
                
                if (newHP < 10) {
                    alert('HPå¤ªä½ï¼Œæ— æ³•æ‹†åˆ†ï¼');
                    return;
                }
                
                const adjCells = this.getAdjacentCells(this.selectedPiece.posX, this.selectedPiece.posY, 1)
                    .filter(c => !c.piece);
                
                if (adjCells.length < numSplit - 1) {
                    alert('å‘¨è¾¹ç©ºä½ä¸è¶³ï¼Œæ— æ³•æ‹†åˆ†ï¼');
                    return;
                }
                
                this.selectedPiece.currentHP = newHP;
                
                const shuffled = adjCells.sort(() => 0.5 - Math.random());
                const originalType = Object.keys(this.roleTypes).find(k => 
                    this.roleTypes[k].name === this.selectedPiece.name && k !== 'king');
                
                for (let i = 0; i < numSplit - 1; i++) {
                    const newRole = {
                        ...this.roleTypes[originalType],
                        hp: newHP,
                        currentHP: newHP,
                        id: Date.now() + Math.random() + i,
                        player: this.selectedPiece.player,
                        alive: true,
                        posX: shuffled[i].x,
                        posY: shuffled[i].y
                    };
                    this.playerRoles[this.selectedPiece.player - 1].push(newRole);
                }
                
                this.selectedPiece = null;
                this.hasMoved = true;
                document.getElementById('action-buttons').style.display = 'none';
                this.renderBoard();
                this.updateUI();
                alert(`æˆåŠŸæ‹†åˆ†æˆ${numSplit}ä¸ªæ£‹å­ï¼`);
            }

            getAdjacentCells(x, y, distance = 1) {
                const cells = [];
                for (let dy = -distance; dy <= distance; dy++) {
                    for (let dx = -distance; dx <= distance; dx++) {
                        if (dx === 0 && dy === 0) continue;
                        if (Math.abs(dx) + Math.abs(dy) > distance) continue;
                        const nx = x + dx;
                        const ny = y + dy;
                        if (nx >= 0 && nx < this.boardWidth && ny >= 0 && ny < this.boardHeight) {
                            const cell = this.getCell(nx, ny);
                            if (cell) cells.push(cell);
                        }
                    }
                }
                return cells;
            }

            showPieceInfo(role) {
                const text = `åç§°: ${role.name}\nHP: ${role.currentHP}/${role.hp}\nATK: ${role.tempATK || role.atk}\né€Ÿåº¦: ${role.speed}\nç©å®¶: ç©å®¶${role.player}`;
                document.getElementById('piece-info-text').textContent = text;
                document.getElementById('piece-info').classList.add('show');
            }

            onCellClick(x, y) {
                if (this.currentPhase !== 'game' || this.gameEnded) return;
                const cellData = this.getCell(x, y);
                if (!cellData) return;
                
                document.getElementById('piece-info').classList.remove('show');
                
                if (this.eventTargetMode && this.currentEvent && this.currentEvent.requiresTarget && cellData.piece) {
                    this.currentEvent.effect(this, cellData.piece);
                    this.endEventMode();
                    return;
                }
                
                if (this.selectedPiece && !this.hasMoved && this.selectedPiece.player === this.currentPlayer) {
                    const distance = this.getManhattanDistance(this.selectedPiece.posX, this.selectedPiece.posY, x, y);
                    
                    if (distance <= this.selectedPiece.speed) {
                        if (!cellData.piece) {
                            this.movePiece(this.selectedPiece, x, y);
                            this.checkAdjacentEnemies(this.selectedPiece);
                            this.hasMoved = true;
                            this.selectedPiece = null;
                            document.getElementById('action-buttons').style.display = 'none';
                            this.renderBoard();
                            this.checkWin();
                        } else if (cellData.piece.player !== this.currentPlayer) {
                            this.attackPiece(this.selectedPiece, cellData.piece, x, y);
                            this.hasMoved = true;
                            this.selectedPiece = null;
                            document.getElementById('action-buttons').style.display = 'none';
                            // ä¼˜åŒ–: å»¶è¿Ÿæ¸²æŸ“ä»¥é¿å…å¡é¡¿
                            setTimeout(() => {
                                this.renderBoard();
                                this.checkWin();
                            }, 10);
                        }
                    } else {
                        this.selectedPiece = null;
                        document.getElementById('action-buttons').style.display = 'none';
                        this.renderBoard();
                    }
                }
            }

            checkAdjacentEnemies(piece) {
                const adjacent = this.getAdjacentCells(piece.posX, piece.posY, 1);
                adjacent.forEach(cell => {
                    if (cell.piece && cell.piece.player !== piece.player && cell.piece.alive) {
                        this.attackPiece(piece, cell.piece, cell.piece.posX, cell.piece.posY);
                    }
                });
            }

            attackPiece(attacker, defender, defX, defY) {
                const atkDamage = attacker.tempATK || attacker.atk;
                const defDamage = defender.tempATK || defender.atk;
                
                defender.currentHP -= atkDamage;
                attacker.currentHP -= defDamage;
                
                let defenderDied = false;
                if (defender.currentHP <= 0) {
                    defender.currentHP = 0;
                    defender.alive = false;
                    defenderDied = true;
                }
                if (attacker.currentHP <= 0) {
                    attacker.currentHP = 0;
                    attacker.alive = false;
                }

                // å¦‚æœé˜²å¾¡æ–¹æ­»äº¡ä¸”æ”»å‡»æ–¹å­˜æ´»ï¼Œåˆ™æ”»å‡»æ–¹ç§»åŠ¨åˆ°é˜²å¾¡æ–¹ä½ç½®
                if (defenderDied && attacker.alive) {
                    this.movePiece(attacker, defX, defY);
                }
                
                // å¦‚æœå‡»è´¥äº†å›½ç‹ï¼Œæ ‡è®°ä¸ºèƒœåˆ©æ”»å‡»
                if (defenderDied && defender.name === 'å›½ç‹') {
                    setTimeout(() => this.playVictorySound(), 100);
                }
            }

            selectPiece(piece) {
                if (piece.player !== this.currentPlayer) {
                    alert('è¯·é€‰æ‹©ä½ è‡ªå·±çš„æ£‹å­ï¼');
                    return;
                }
                
                if (this.hasMoved) {
                    alert('æœ¬å›åˆå·²ç»ç§»åŠ¨è¿‡äº†ï¼');
                    return;
                }
                
                this.selectedPiece = piece;
                this.selectedGroup = [piece];
                this.renderBoard();
                this.showPieceInfo(piece);
                document.getElementById('action-buttons').style.display = 'block';
                document.getElementById('game-hint').textContent = 'ç‚¹å‡»å¯è¾¾æ ¼å­ç§»åŠ¨/æ”»å‡»';
                this.updateGroupUI();
            }

            highlightMovable() {
                if (!this.selectedPiece) return;
                const sx = this.selectedPiece.posX;
                const sy = this.selectedPiece.posY;
                const speed = this.selectedPiece.speed;
                
                for (let y = 0; y < this.boardHeight; y++) {
                    for (let x = 0; x < this.boardWidth; x++) {
                        const distance = this.getManhattanDistance(sx, sy, x, y);
                        if (distance > 0 && distance <= speed) {
                            const cellData = this.getCell(x, y);
                            if (cellData) {
                                if (!cellData.piece) {
                                    cellData.element.classList.add('movable');
                                } else if (cellData.piece.player !== this.currentPlayer && cellData.piece.alive) {
                                    cellData.element.classList.add('attackable');
                                }
                            }
                        }
                    }
                }
            }

            movePiece(piece, tx, ty) {
                const fromCell = this.getCell(piece.posX, piece.posY);
                if (fromCell) fromCell.piece = null;
                
                piece.posX = tx;
                piece.posY = ty;
                
                const toCell = this.getCell(tx, ty);
                if (toCell) {
                    toCell.piece = piece;
                    
                    if (toCell.obstacle && !toCell.obstacle.revealed) {
                        toCell.obstacle.revealed = true;
                        if (toCell.obstacle.type === 'heal') {
                            piece.currentHP = Math.min(piece.hp, piece.currentHP + toCell.obstacle.amount);
                            alert(`è·å¾—æ²»ç–— +${toCell.obstacle.amount} HPï¼`);
                        } else {
                            piece.currentHP = Math.max(1, piece.currentHP - toCell.obstacle.amount);
                            alert(`å—åˆ°ä¼¤å®³ -${toCell.obstacle.amount} HPï¼`);
                        }
                    }
                }
            }

            checkWin() {
                for (let p = 1; p <= 2; p++) {
                    const roles = this.playerRoles[p - 1];
                    const king = roles.find(r => r.name === 'å›½ç‹');
                    if (king && king.currentHP <= 0) {
                        king.alive = false;
                        const winner = p === 1 ? 2 : 1;
                        document.getElementById('winner-banner').textContent = `ç©å®¶${winner} è·èƒœï¼`;
                        document.getElementById('winner-banner').classList.add('show');
                        this.gameEnded = true;
                        this.playVictorySound();
                        return;
                    }
                }
            }

            drawRandomEvent() {
                const drawsLeft = this.eventDraws[this.currentPlayer - 1];
                if (drawsLeft <= 0) {
                    alert('æŠ½å–æ¬¡æ•°å·²ç”¨å®Œï¼');
                    return;
                }
                if (this.hasMoved) {
                    alert('æœ¬å›åˆå·²ç»ç§»åŠ¨è¿‡äº†ï¼');
                    return;
                }

                this.eventDraws[this.currentPlayer - 1]--;
                const randomEvent = this.randomEvents[Math.floor(Math.random() * this.randomEvents.length)];
                this.currentEvent = randomEvent;

                document.getElementById('event-draws').textContent = this.eventDraws[this.currentPlayer - 1];
                document.getElementById('draw-event-btn').disabled = this.eventDraws[this.currentPlayer - 1] <= 0;

                const descEl = document.getElementById('event-description');
                descEl.textContent = `${randomEvent.name}: ${randomEvent.description}`;
                descEl.style.display = 'block';

                if (randomEvent.requiresTarget) {
                    this.eventTargetMode = true;
                    document.getElementById('event-target-hint').style.display = 'block';
                    document.getElementById('game-hint').textContent = 'ç‚¹å‡»æ£‹ç›˜ä¸Šä»»æ„æ£‹å­åº”ç”¨äº‹ä»¶';
                    alert(`æŠ½å–åˆ°: ${randomEvent.name}\n${randomEvent.description}\nç‚¹å‡»ä»»æ„æ£‹å­åº”ç”¨ã€‚`);
                } else {
                    randomEvent.effect(this);
                    this.renderBoard();
                    this.checkWin();
                }
            }

            endEventMode() {
                this.currentEvent = null;
                this.eventTargetMode = false;
                document.getElementById('event-description').style.display = 'none';
                document.getElementById('event-target-hint').style.display = 'none';
                document.getElementById('game-hint').textContent = this.selectedPiece ? 
                    'ç‚¹å‡»å¯è¾¾æ ¼å­ç§»åŠ¨/æ”»å‡»' : 'ç‚¹å‡»ä½ çš„æ£‹å­é€‰æ‹©';
                this.renderBoard();
                this.checkWin();
            }

            endTurn() {
                if (!this.hasMoved && this.selectedPiece) {
                    const confirm = window.confirm('è¿˜æ²¡æœ‰ç§»åŠ¨æ£‹å­ï¼Œç¡®å®šè¦ç»“æŸå›åˆå—ï¼Ÿ');
                    if (!confirm) return;
                }
                
                // æ¸…ç†ä¸´æ—¶buff
                this.playerRoles.flat().forEach(role => {
                    if (role.tempATK) delete role.tempATK;
                });
                
                this.currentPlayer = 3 - this.currentPlayer;
                this.selectedPiece = null;
                this.selectedGroup = [];
                this.groupSelectMode = false;
                this.hasMoved = false;
                document.getElementById('action-buttons').style.display = 'none';
                this.updateGroupUI();
                this.endEventMode();
                this.renderBoard();
                this.updateUI();
            }

            updateUI() {
                const p1Count = this.getAliveCount(1);
                const p2Count = this.getAliveCount(2);
                
                document.getElementById('p1-pieces-top').textContent = p1Count;
                document.getElementById('p2-pieces-top').textContent = p2Count;
                
                if (this.currentPhase === 'setup') {
                    document.querySelectorAll('.turn-status').forEach(el => el.textContent = 'å‡†å¤‡ä¸­');
                    document.getElementById('player1-info').classList.remove('current-turn');
                    document.getElementById('player2-info').classList.remove('current-turn');
                } else {
                    document.querySelectorAll('.turn-status').forEach((el, idx) => {
                        const playerNum = idx === 0 ? 1 : 2;
                        el.textContent = playerNum === this.currentPlayer ? 'âœ“ å½“å‰å›åˆ' : 'ç­‰å¾…ä¸­';
                    });
                    const currentEl = document.getElementById(`player${this.currentPlayer}-info`);
                    if (currentEl) currentEl.classList.add('current-turn');
                    const otherEl = document.getElementById(`player${3 - this.currentPlayer}-info`);
                    if (otherEl) otherEl.classList.remove('current-turn');
                    document.getElementById('current-player-text').textContent = `ç©å®¶${this.currentPlayer}`;
                    document.getElementById('p1-pieces-game').textContent = p1Count;
                    document.getElementById('p2-pieces-game').textContent = p2Count;
                    document.getElementById('game-hint').textContent = this.selectedPiece ? 
                        'ç‚¹å‡»å¯è¾¾æ ¼å­ç§»åŠ¨/æ”»å‡»' : 'ç‚¹å‡»ä½ çš„æ£‹å­é€‰æ‹©';

                    // æ›´æ–°äº‹ä»¶æŠ½å–UI
                    const currentDraws = this.eventDraws[this.currentPlayer - 1];
                    document.getElementById('event-draws').textContent = currentDraws;
                    document.getElementById('draw-event-btn').disabled = currentDraws <= 0 || this.gameEnded;
                }
            }

            resetGame() {
                this.playerRoles = [[], []];
                this.playerWealth = [1000, 1000];
                this.selectedPiece = null;
                this.selectedGroup = [];
                this.groupSelectMode = false;
                this.currentPlayer = 1;
                this.setupPlayer = 1;
                this.gameStarted = false;
                this.gameEnded = false;
                this.hasMoved = false;
                this.currentPhase = 'setup';
                this.eventDraws = [3, 3];
                this.currentEvent = null;
                this.eventTargetMode = false;
                document.body.classList.remove('game-active');
                document.getElementById('start-game-btn').disabled = true;
                document.getElementById('action-buttons').style.display = 'none';
                this.initBoard();
                this.generateObstacles();
                this.renderBoard();
                document.getElementById('piece-info').classList.remove('show');
                document.getElementById('winner-banner').classList.remove('show');
                this.updateSelectedCount();
                this.updateWealthDisplay();
                this.updateUI();
            }
        }

        const game = new Game();
    </script>
</body>
</html>
